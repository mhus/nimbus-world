version: '3.8'

# All world services and client services.
# Infrastructyre services are not included and are used from local host.

services:
  # Backend Services

  world-player:
    image: nimbus-world-player:latest
    container_name: nimbus-world-player
    ports:
      - "9042:9042"
    environment:
      - NIMBUS_EXTERNAL_URL=${NIMBUS_EXTERNAL_URL:-http://localhost:9042}
      - NIMBUS_SERVER_IP=${NIMBUS_SERVER_IP:-world-player}
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:example@host.docker.internal:27017/world?authSource=admin}
      - REDIS_URL=${REDIS_URL:-redis://host.docker.internal:6379}
      - REDIS_HOST=${REDIS_HOST:-host.docker.internal}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DATABASE=${REDIS_DATABASE:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_SSL=${REDIS_SSL:-false}
      - PLAYER_BASE_URL=${PLAYER_BASE_URL:-http://world-player:9042}
      - LIFE_BASE_URL=${LIFE_BASE_URL:-http://world-life:9044}
      - CONTROL_BASE_URL=${CONTROL_BASE_URL:-http://world-control:9043}
      - NIMBUS_ENCRYPTION_PASSWORD=${NIMBUS_ENCRYPTION_PASSWORD:-changeme}
      - CHUNK_COMPRESSION_ENABLED=${CHUNK_COMPRESSION_ENABLED:-true}
      - LAYER_TERRAIN_COMPRESSION_ENABLED=${LAYER_TERRAIN_COMPRESSION_ENABLED:-true}
      - ASSET_COMPRESSION_ENABLED=${ASSET_COMPRESSION_ENABLED:-true}
      - NIMBUS_SCHEMA_AUTO_MIGRATE=${NIMBUS_SCHEMA_AUTO_MIGRATE:-false}
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9042/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  world-control:
    image: nimbus-world-control:latest
    container_name: nimbus-world-control
    ports:
      - "9043:9043"
    environment:
      - NIMBUS_EXTERNAL_URL=${NIMBUS_EXTERNAL_URL:-http://localhost:9043}
      - NIMBUS_SERVER_IP=${NIMBUS_SERVER_IP:-world-control}
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:example@host.docker.internal:27017/world?authSource=admin}
      - REDIS_HOST=${REDIS_HOST:-host.docker.internal}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DATABASE=${REDIS_DATABASE:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_SSL=${REDIS_SSL:-false}
      - PLAYER_BASE_URL=${PLAYER_BASE_URL:-http://world-player:9042}
      - LIFE_BASE_URL=${LIFE_BASE_URL:-http://world-life:9044}
      - CONTROL_BASE_URL=${CONTROL_BASE_URL:-http://world-control:9043}
      - NIMBUS_ENCRYPTION_PASSWORD=${NIMBUS_ENCRYPTION_PASSWORD:-changeme}
      - CHUNK_COMPRESSION_ENABLED=${CHUNK_COMPRESSION_ENABLED:-true}
      - LAYER_TERRAIN_COMPRESSION_ENABLED=${LAYER_TERRAIN_COMPRESSION_ENABLED:-true}
      - ASSET_COMPRESSION_ENABLED=${ASSET_COMPRESSION_ENABLED:-true}
      - NIMBUS_SCHEMA_AUTO_MIGRATE=${NIMBUS_SCHEMA_AUTO_MIGRATE:-true}
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9043/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  world-life:
    image: nimbus-world-life:latest
    container_name: nimbus-world-life
    ports:
      - "9044:9044"
    environment:
      - NIMBUS_EXTERNAL_URL=${NIMBUS_EXTERNAL_URL:-http://localhost:9044}
      - NIMBUS_SERVER_IP=${NIMBUS_SERVER_IP:-world-life}
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:example@host.docker.internal:27017/world?authSource=admin}
      - REDIS_HOST=${REDIS_HOST:-host.docker.internal}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DATABASE=${REDIS_DATABASE:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_SSL=${REDIS_SSL:-false}
      - PLAYER_BASE_URL=${PLAYER_BASE_URL:-http://world-player:9042}
      - LIFE_BASE_URL=${LIFE_BASE_URL:-http://world-life:9044}
      - CONTROL_BASE_URL=${CONTROL_BASE_URL:-http://world-control:9043}
      - NIMBUS_ENCRYPTION_PASSWORD=${NIMBUS_ENCRYPTION_PASSWORD:-changeme}
      - CHUNK_COMPRESSION_ENABLED=${CHUNK_COMPRESSION_ENABLED:-true}
      - LAYER_TERRAIN_COMPRESSION_ENABLED=${LAYER_TERRAIN_COMPRESSION_ENABLED:-true}
      - ASSET_COMPRESSION_ENABLED=${ASSET_COMPRESSION_ENABLED:-true}
      - NIMBUS_SCHEMA_AUTO_MIGRATE=${NIMBUS_SCHEMA_AUTO_MIGRATE:-false}
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9044/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  world-generator:
    image: nimbus-world-generator:latest
    container_name: nimbus-world-generator
    ports:
      - "9045:9045"
    environment:
      - NIMBUS_EXTERNAL_URL=${NIMBUS_EXTERNAL_URL:-http://localhost:9045}
      - NIMBUS_SERVER_IP=${NIMBUS_SERVER_IP:-world-generator}
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:example@host.docker.internal:27017/world?authSource=admin}
      - REDIS_HOST=${REDIS_HOST:-host.docker.internal}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DATABASE=${REDIS_DATABASE:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_SSL=${REDIS_SSL:-false}
      - PLAYER_BASE_URL=${PLAYER_BASE_URL:-http://world-player:9042}
      - LIFE_BASE_URL=${LIFE_BASE_URL:-http://world-life:9044}
      - CONTROL_BASE_URL=${CONTROL_BASE_URL:-http://world-control:9043}
      - NIMBUS_ENCRYPTION_PASSWORD=${NIMBUS_ENCRYPTION_PASSWORD:-changeme}
      - CHUNK_COMPRESSION_ENABLED=${CHUNK_COMPRESSION_ENABLED:-true}
      - LAYER_TERRAIN_COMPRESSION_ENABLED=${LAYER_TERRAIN_COMPRESSION_ENABLED:-true}
      - ASSET_COMPRESSION_ENABLED=${ASSET_COMPRESSION_ENABLED:-true}
      - NIMBUS_SCHEMA_AUTO_MIGRATE=${NIMBUS_SCHEMA_AUTO_MIGRATE:-false}
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9045/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Frontend Services

  viewer:
    image: nimbus-viewer:latest
    container_name: nimbus-viewer
    ports:
      - "3000:3000"
    environment:
      - VITE_SERVER_API_URL=${VITE_SERVER_API_URL:-http://localhost:9042}
      - VITE_EXIT_URL=${VITE_EXIT_URL:-http://localhost:3002/dev-login.html}
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  editor:
    image: nimbus-editor:latest
    container_name: nimbus-editor
    ports:
      - "3001:3001"
    environment:
      - VITE_SERVER_API_URL=${VITE_SERVER_API_URL:-http://localhost:9042}
      - VITE_EXIT_URL=${VITE_EXIT_URL:-http://localhost:3002/dev-login.html}
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  controls:
    image: nimbus-controls:latest
    container_name: nimbus-controls
    ports:
      - "3002:3002"
    environment:
      - VITE_CONTROL_API_URL=${VITE_CONTROL_API_URL:-http://localhost:9043}
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  nimbus-network:
    driver: bridge
