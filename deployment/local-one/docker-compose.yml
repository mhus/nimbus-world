version: '3.8'

services:
  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: nimbus-nginx
    ports:
      - "8080:8080"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - nimbus-network
    depends_on:
      world-player:
        condition: service_healthy
      world-control:
        condition: service_healthy
      world-life:
        condition: service_healthy
      viewer:
        condition: service_healthy
      editor:
        condition: service_healthy
      controls:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pidof","nginx"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Backend Services

  world-player:
    image: nimbus-world-player:latest
    container_name: nimbus-world-player
    expose:
      - "9042"
    environment:
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:example@host.docker.internal:27017/world?authSource=admin}
      - REDIS_URL=${REDIS_URL:-redis://host.docker.internal:6379}
      - REDIS_HOST=${REDIS_HOST:-host.docker.internal}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DATABASE=${REDIS_DATABASE:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_SSL=${REDIS_SSL:-false}
      - PLAYER_BASE_URL=${PLAYER_BASE_URL:-http://world-player:9042}
      - LIFE_BASE_URL=${LIFE_BASE_URL:-http://world-life:9044}
      - CONTROL_BASE_URL=${CONTROL_BASE_URL:-http://world-control:9043}
      - NIMBUS_ENCRYPTION_PASSWORD=${NIMBUS_ENCRYPTION_PASSWORD:-changeme}
      - CHUNK_COMPRESSION_ENABLED=${CHUNK_COMPRESSION_ENABLED:-true}
      - LAYER_TERRAIN_COMPRESSION_ENABLED=${LAYER_TERRAIN_COMPRESSION_ENABLED:-true}
      - ASSET_COMPRESSION_ENABLED=${ASSET_COMPRESSION_ENABLED:-true}
      - NIMBUS_SCHEMA_AUTO_MIGRATE=${NIMBUS_SCHEMA_AUTO_MIGRATE:-false}
      - NIMBUS_WEBSOCKET_URL=ws://localhost:8080/player/ws
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9042/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  world-control:
    image: nimbus-world-control:latest
    container_name: nimbus-world-control
    expose:
      - "9043"
#    ports:
#      - "9043:9043"
    environment:
#      - NIMBUS_EXTERNAL_URL=${NIMBUS_EXTERNAL_URL:-http://localhost:9043}
#      - NIMBUS_SERVER_IP=${NIMBUS_SERVER_IP:-world-control}
#      - NIMBUS_ACCESS_URLS=http://localhost:9042/player/aaa/authorize,http://localhost:9043/control/aaa/authorize
      - NIMBUS_ACCESS_URLS=/player/aaa/authorize,/control/aaa/authorize
      - NIMBUS_JUMP_URL_AGENT=/controls
      - NIMBUS_JUMP_URL_EDITOR=/editor?worldId={worldId}&session={session}
      - NIMBUS_JUMP_URL_VIEWER=/viewer?worldId={worldId}&session={session}
      - NIMBUS_LOGIN_URL=/control/dev-login.html
      - NIMBUS_LOGOUT_URL=/control/dev-login.html
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:example@host.docker.internal:27017/world?authSource=admin}
      - REDIS_HOST=${REDIS_HOST:-host.docker.internal}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DATABASE=${REDIS_DATABASE:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_SSL=${REDIS_SSL:-false}
      - PLAYER_BASE_URL=${PLAYER_BASE_URL:-http://world-player:9042}
      - LIFE_BASE_URL=${LIFE_BASE_URL:-http://world-life:9044}
      - CONTROL_BASE_URL=${CONTROL_BASE_URL:-http://world-control:9043}
      - NIMBUS_ENCRYPTION_PASSWORD=${NIMBUS_ENCRYPTION_PASSWORD:-changeme}
      - CHUNK_COMPRESSION_ENABLED=${CHUNK_COMPRESSION_ENABLED:-true}
      - LAYER_TERRAIN_COMPRESSION_ENABLED=${LAYER_TERRAIN_COMPRESSION_ENABLED:-true}
      - ASSET_COMPRESSION_ENABLED=${ASSET_COMPRESSION_ENABLED:-true}
      - NIMBUS_SCHEMA_AUTO_MIGRATE=${NIMBUS_SCHEMA_AUTO_MIGRATE:-true}
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9043/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  world-life:
    image: nimbus-world-life:latest
    container_name: nimbus-world-life
    expose:
      - "9044"
    environment:
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:example@host.docker.internal:27017/world?authSource=admin}
      - REDIS_HOST=${REDIS_HOST:-host.docker.internal}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DATABASE=${REDIS_DATABASE:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_SSL=${REDIS_SSL:-false}
      - PLAYER_BASE_URL=${PLAYER_BASE_URL:-http://world-player:9042}
      - LIFE_BASE_URL=${LIFE_BASE_URL:-http://world-life:9044}
      - CONTROL_BASE_URL=${CONTROL_BASE_URL:-http://world-control:9043}
      - NIMBUS_ENCRYPTION_PASSWORD=${NIMBUS_ENCRYPTION_PASSWORD:-changeme}
      - CHUNK_COMPRESSION_ENABLED=${CHUNK_COMPRESSION_ENABLED:-true}
      - LAYER_TERRAIN_COMPRESSION_ENABLED=${LAYER_TERRAIN_COMPRESSION_ENABLED:-true}
      - ASSET_COMPRESSION_ENABLED=${ASSET_COMPRESSION_ENABLED:-true}
      - NIMBUS_SCHEMA_AUTO_MIGRATE=${NIMBUS_SCHEMA_AUTO_MIGRATE:-false}
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9044/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  world-generator:
    image: nimbus-world-generator:latest
    container_name: nimbus-world-generator
    expose:
      - "9045"
    environment:
      - MONGODB_URI=${MONGODB_URI:-mongodb://root:example@host.docker.internal:27017/world?authSource=admin}
      - REDIS_HOST=${REDIS_HOST:-host.docker.internal}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DATABASE=${REDIS_DATABASE:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_SSL=${REDIS_SSL:-false}
      - PLAYER_BASE_URL=${PLAYER_BASE_URL:-http://world-player:9042}
      - LIFE_BASE_URL=${LIFE_BASE_URL:-http://world-life:9044}
      - CONTROL_BASE_URL=${CONTROL_BASE_URL:-http://world-control:9043}
      - NIMBUS_ENCRYPTION_PASSWORD=${NIMBUS_ENCRYPTION_PASSWORD:-changeme}
      - CHUNK_COMPRESSION_ENABLED=${CHUNK_COMPRESSION_ENABLED:-true}
      - LAYER_TERRAIN_COMPRESSION_ENABLED=${LAYER_TERRAIN_COMPRESSION_ENABLED:-true}
      - ASSET_COMPRESSION_ENABLED=${ASSET_COMPRESSION_ENABLED:-true}
      - NIMBUS_SCHEMA_AUTO_MIGRATE=${NIMBUS_SCHEMA_AUTO_MIGRATE:-false}
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9045/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Frontend Services

  viewer:
    image: nimbus-viewer:latest
    container_name: nimbus-viewer
    expose:
      - "3000"
    environment:
      - VITE_SERVER_API_URL=http://localhost:8080
      - VITE_EXIT_URL=http://localhost:8080/controls/dev-login.html
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  editor:
    image: nimbus-editor:latest
    container_name: nimbus-editor
    expose:
      - "3001"
#    ports:
#      - "3001:3001"
    environment:
      - VITE_SERVER_API_URL=http://localhost:8080
      - VITE_EXIT_URL=http://localhost:8080/controls/dev-login.html
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  controls:
    image: nimbus-controls:latest
    container_name: nimbus-controls
    expose:
      - "3002"
    environment:
      - VITE_CONTROL_API_URL=http://localhost:8080/
    networks:
      - nimbus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  nimbus-network:
    driver: bridge
